<!doctype html>
<html> 
<head>
<title>Wikileaks Cable Map</title>
<script src="/static/default/js/jquery.min.js" type="text/javascript"></script> 
<script type="text/javascript"
  src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript"> 
var image = new google.maps.MarkerImage('/projects/cablemap/images/mm_20_red.png',
  new google.maps.Size(12, 20),
  new google.maps.Point(0,0),
  new google.maps.Point(6, 20));
var shadow = new google.maps.MarkerImage('/projects/cablemap/images/mm_20_shadow.png',
  new google.maps.Size(22, 20),
  new google.maps.Point(0,0),
  new google.maps.Point(6, 20));
var shape = {
  coord: [4,0,0,4,0,7,3,11,4,19,7,19,8,11,11,7,11,4,7,0],
  type: 'poly'
};
var infowindow = new google.maps.InfoWindow();
var map=null;
var markerArray=[];
var sideQuery="";

function initialize() {
  var myLatlng = new google.maps.LatLng(23,0);
  var myOptions = {
  zoom: 2,
  center: myLatlng,
  mapTypeId: google.maps.MapTypeId.ROADMAP
  }
  map = new google.maps.Map(document.getElementById("map_canvas"),
         myOptions);
  $.getJSON('/projects/cablemap/sources.json', function(data) {
      $.each(data, function(i, source) {
          markerArray.push(createMarker(source));
      });
  });
}

function jsonReq(requestURL){
  var script = document.createElement('script');
  script.src = requestURL;
  script.type = 'text/javascript';
  var head = document.getElementsByTagName('head').item(0);
  head.appendChild(script);
}

function getCables(query,offset){
  sideQuery = query;
  var sideUrl='http://cablesearch.org/cable/api/search?jsonp=fillSide&q='+
            encodeURIComponent(query)+"&o="+offset;
  jsonReq(sideUrl);
}

function getCable(id){
  var url='http://cablesearch.org/cable/api/cable?jsonp=showCable&id='+
            encodeURIComponent(id);
  jsonReq(url);
}

function fillSide(data) {
  $("#cables").html("");
  var str="";
  $.each(data.items,function(i, cable){
    str ="<div class='cable'>";
    str+=cable.subject.toLowerCase()+"<br/>";
    str+=cable.date.split(' ')[0]+"&nbsp;&nbsp";
    str+="<a href='#' onclick='getCable(\""+cable.id+"\")'>View Cable</a><br/>";
    str+="</div>";
    $("#cables").append(str);
  });
  if(data.info.offset!=0)
    $("#cables").append("<a href='#' onclick='getCables(sideQuery,"+
      (data.info.offset-10)+")'> &lt; Prev</a> ");
  var start = data.info.offset+1;
  var end = data.info.offset+data.info.items;
  $("#cables").append("Showing " + start + "-" + end);
  if(typeof(data.info.nextoffset)=='number')
    $("#cables").append("<a href='#' onclick='getCables(sideQuery,"+
      data.info.nextoffset+")'> Next &gt; </a>");
}

function showCable(data) {
    var cable = "<a href='#' onclick=\"$('#cableDiv').hide();";
    cable+="$('#map_canvas').show();\">Back to map</a>"; 
    cable+="<h3>"+data.items[0].subject+"</h3>";
    cable+="Origin: "+data.items[0].origin+"<br/>";
    cable+="Date: "+data.items[0].date+"<br/>";
    cable+="ID: "+data.items[0].id+"<br/>";
    cable+="Original Link: <a href='"+data.items[0].link+"' target='_blank'>"+
            data.items[0].link+"</a><br/>";
    cable+="Cached Link: <a href='"+data.items[0].cachelink+"' target='_blank'>"+
            data.items[0].cachelink+"</a><br/><br/>";
    cable+=data.items[0].text.replace( /\n/g, '<br />\n' );
    $("#cableDiv").html(cable);
    $("#map_canvas").hide();
    $("#cableDiv").show();
}
function createMarker(source){
    var latLng = new google.maps.LatLng(source.lat, source.lng);
    var contentStr = "<div class='info'>"
            + source.location +"<br/>" + source.count + " cables";
    var marker = new google.maps.Marker({
        position: latLng,
        map: map,
        icon: image,
        shape: shape,
        shadow: shadow,
        title: source.location
    });
    
    google.maps.event.addListener(marker, 'click', function() {
        infowindow.setContent(contentStr);
        infowindow.open(map,marker);
        getCables(source.query,0)
    });
    return marker;
}
</script> 
<link rel="SHORTCUT ICON" href="/static/default/favicon.ico"/> 
<link rel="stylesheet" type="text/css" media="screen" 
    href="http://www.hrishibakshi.com/static/default/css/screen.css" /> 
<style>
#map_canvas img {
    background: none;
    border: 0;
    padding: 0;
}
.cable {
    padding: 2px;
    border-bottom: 1px solid silver;
}
</style>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-20392913-1']);
  _gaq.push(['_setDomainName', '.hrishibakshi.com']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>  
</head> 
<body onload="initialize()"> 
<div id="header-wrap"><div id="header" class="container_16" style="height:50px;">
	<div  id="nav"> 
		<ul> 
			<li><a href="/">Home</a></li> 
            <li> 
              <a href="/about/">about</a> 
            </li>               
            <li> 
              <a href="/projects/">projects</a> 
            </li> 
		</ul> 
	</div>		
</div></div> 

<div id="content-outer"><div id="content-wrapper" class="container_16">
    <h2><a href="/cablemap" title="">Wikileaks Cablemap</a></h2>		
    <div id="left-columns" class="grid_4">
        <a href="http://twitter.com/share" class="twitter-share-button"
            data-url="http://goo.gl/W0zfm"
            data-text="Watch #wikileaks cable map"
            data-count="none" 
            data-via="hsbakshi">Tweet</a>
        <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
        <iframe src="http://www.facebook.com/plugins/like.php?href=http%3A%2F%2Fwww.hrishibakshi.com%2Fcablemap%2F&amp;layout=button_count&amp;show_faces=false&amp;width=100&amp;action=like&amp;colorscheme=light&amp;height=21" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:100px; height:21px;" allowTransparency="true"></iframe>
      <br />
      <div id="cables">
        Click on a marker to see cables.
      </div>
    </div>
    <div class="grid_12">
        <div id="cableDiv" style="width:95%;display:none;"> 
        </div>
        <div id="map_canvas" style="height:500px;width:100%;display:block;"> 
        </div>
    </div>
    
  <!--  <h3 id="comments">Comments</h3> 
    <div id="disqus_thread"></div> 
    <script type="text/javascript" src="http://disqus.com/forums/hrishi/embed.js"></script> 
    <noscript><a href="http://disqus.com/forums/hrishi/?url=ref">View the discussion thread.</a></noscript> 
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by 
        <span class="logo-disqus">Disqus</span>
    </a> -->
</div></div>

<div id="footer-wrapper" class="container_16"> 
	<div id="footer-bottom"> 
		<p class="bottom-left">			
		&nbsp; &copy; Hrishikesh Bakshi &nbsp; &nbsp;
		Design by : <a href="http://www.styleshout.com/">styleshout</a>
        &nbsp;&nbsp;Data by : <a href="http://cablesearch.org/">Cablesearch</a>
		</p>	
		<p class="bottom-right" > 
			<a href="/">Home</a> |
            <a href="/feeds/atom.xml">Atom</a> |
			<a href="http://jigsaw.w3.org/css-validator/check/referer">CSS</a> | 
	   	    <a href="http://validator.w3.org/check/referer">XHTML</a> 
		</p> 
	</div>	
</div>  
</body> 
</html> 
